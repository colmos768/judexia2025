{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <h2 class="mb-4">üìä Panel de Facturaci√≥n</h2>

  <!-- Filtros -->
<form method="get" action="{{ url_for('facturacion') }}" class="row g-3 align-items-end mb-4">
  <div class="col-md-4">
    <label for="cliente_id" class="form-label">Filtrar por cliente</label>
    <select name="cliente_id" id="cliente_id" class="form-select">
      <option value="">Todos</option>
      {% for cliente in clientes %}
        <option value="{{ cliente.id }}" {% if selected_cliente == cliente.id|string %}selected{% endif %}>
          {{ cliente.nombre }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-4">
    <label for="estado" class="form-label">Filtrar por estado de pago</label>
    <select name="estado" id="estado" class="form-select">
      <option value="">Todos</option>
      <option value="pendiente" {% if selected_estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
      <option value="pagado" {% if selected_estado == 'pagado' %}selected{% endif %}>Pagado</option>
      <option value="vencida" {% if selected_estado == 'vencida' %}selected{% endif %}>Vencida</option>
    </select>
  </div>

  <div class="col-md-4 d-flex gap-2">
    <button type="submit" class="btn btn-primary">Aplicar filtros</button>
    <a href="{{ url_for('facturacion') }}" class="btn btn-secondary">Limpiar</a>
  </div>
</form>

  <!-- Botones de acci√≥n -->
  <div class="d-flex justify-content-between mb-3">
    <div>
      <a href="{{ url_for('registrar_honorario') }}" class="btn btn-success">‚ûï Registrar Honorario</a>
      <a href="{{ url_for('exportar_facturacion') }}" class="btn btn-secondary">‚¨áÔ∏è Exportar CSV</a>
    </div>
  </div>

  <!-- Resumen financiero -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card border-primary">
        <div class="card-body">
          <h5 class="card-title text-primary">üí∞ Total Facturado</h5>
          <p class="card-text fw-bold">${{ honorarios|sum(attribute='monto_total')|round(0) }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-success">
        <div class="card-body">
          <h5 class="card-title text-success">‚úÖ Total Pagado</h5>
          <p class="card-text fw-bold">
            ${{ pagos|sum(attribute='monto_pagado')|round(0) }}
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-danger">
        <div class="card-body">
          <h5 class="card-title text-danger">‚ö†Ô∏è Cuotas Vencidas</h5>
          <p class="card-text fw-bold">
            {{ pagos|selectattr("estado", "equalto", "vencida")|list|length }} cuotas
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de honorarios -->
  <h4 class="mt-4">üìÑ Honorarios Emitidos</h4>
  <table class="table table-striped table-bordered mt-2">
    <thead class="table-light">
      <tr>
        <th>Cliente</th>
        <th>Causa</th>
        <th>Descripci√≥n</th>
        <th>Monto</th>
        <th>Cuotas</th>
        <th>Fecha</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody>
      {% for h in honorarios %}
      <tr>
        <td>{{ h.cliente.nombre }}</td>
        <td>{{ h.causa.rol if h.causa else '‚Äî' }}</td>
        <td>{{ h.descripcion }}</td>
        <td>${{ h.monto_total }}</td>
        <td>{{ h.numero_cuotas }}</td>
        <td>{{ h.fecha_emision.strftime('%d-%m-%Y') }}</td>
        <td>{{ h.estado }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Tabla de pagos -->
  <h4 class="mt-5">üí≥ Pagos Registrados</h4>
  <table class="table table-striped table-bordered mt-2">
    <thead class="table-light">
      <tr>
        <th>Cliente</th>
        <th>Cuota N¬∫</th>
        <th>Monto</th>
        <th>Pagado</th>
        <th>Vencimiento</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody>
      {% for p in pagos %}
      <tr>
        <td>{{ p.honorario.cliente.nombre }}</td>
        <td>{{ p.numero_cuota }}</td>
        <td>${{ p.monto_pagado }}</td>
        <td>{{ p.fecha_pago.strftime('%d-%m-%Y') if p.fecha_pago else '‚Äî' }}</td>
        <td>{{ p.vencimiento.strftime('%d-%m-%Y') if p.vencimiento else '‚Äî' }}</td>
        <td>{{ p.estado }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Espacio para gr√°fico -->
<div class="mt-5">
  <h4>üìà Gr√°fico de Pagos</h4>
  <canvas id="graficoPagos" height="100"></canvas>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('graficoPagos').getContext('2d');
  const graficoPagos = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
      datasets: [{
        label: 'Pagos semanales',
        data: [150000, 90000, 120000, 70000],
        borderWidth: 1,
        backgroundColor: 'rgba(54, 162, 235, 0.6)'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('graficoPagos').getContext('2d');
  const graficoPagos = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
      datasets: [{
        label: 'Pagos semanales',
        data: [150000, 90000, 120000, 70000],  // puedes reemplazar con datos reales
        borderWidth: 1,
        backgroundColor: 'rgba(54, 162, 235, 0.6)'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
</script>
{% endblock %}

